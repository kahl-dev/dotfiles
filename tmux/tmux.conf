# idol: https://github.com/samoshkin/tmux-config

source-file ~/.tmux/.tmux.reset.conf

# General settings {{{
# =============================================================================

# Add true color & italics support with alacritty terminal
set -g default-terminal "screen-256color"
# set -sa terminal-overrides ',screen-256color:RGB'

setw -g xterm-keys on
set -s escape-time 10         # faster command sequences
set -sg repeat-time 600       # increase repeat timeout
set -s focus-events on

set -q -g status-utf8 on      # expect UTF-8 (tmux < 2.2)
setw -q -g utf8 on

set -g history-limit 5000     # boost history

set -g renumber-windows on    # renumber window after close
set -g prefix C-a             # change prefix
set -g mouse on               # Enable mouse support

set -g base-index 1           # start windows numbering at 1
setw -g pane-base-index 1     # make pane numbering consistent with windows

setw -g automatic-rename on   # rename window to reflect current program
set -g renumber-windows on    # renumber windows when a window is closed

set -g set-titles on          # set terminal title

# }}}

# Display {{{
# =============================================================================

set -g base-index 1           # start windows numbering at 1
setw -g pane-base-index 1     # make pane numbering consistent with windows

setw -g automatic-rename on   # rename window to reflect current program
set -g renumber-windows on    # renumber windows when a window is closed

set -g set-titles on          # set terminal title

set -g display-panes-time 800 # slightly longer pane indicators display time
set -g display-time 1000      # slightly longer status messages display time

set -g status-interval 10     # redraw status line every 10 seconds

# activity
set -g monitor-activity on
set -g visual-activity off

# }}}

# Floating popup {{{
# =============================================================================


bind-key j run-shell '~/.tmux/tmux.popup.sh'
# bind-key j display-popup -w 80% -E "ls ~/public_html | fzf"

# }}}

# Key bindings {{{
# =============================================================================

# create session
bind C-c new-session

# resize panes like vim
bind-key -r Left resize-pane -L 5
bind-key -r Down resize-pane -D 5
bind-key -r Up resize-pane -U 5
bind-key -r Right resize-pane -R 6

# Split panes
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Zoom pane
bind z resize-pane -Z

# Kill pane/window/session shortcuts
bind x kill-pane
bind X kill-window
bind Q confirm-before -p "kill-session #S? (y/n)" kill-session

# Move windows
#https://superuser.com/questions/343572/how-do-i-reorder-tmux-windows#answer-552493
bind-key -n C-S-Left swap-window -t -1 \;\
  select-window -t -1
bind-key -n C-S-Right swap-window -t +1 \;\
  select-window -t +1

bind R source-file ~/.tmux.conf \; display-message "~/.tmux.conf sourced"

# bind l unbind-key -a \; source-file ~/.tmux/.tmux.reset.conf \; source-file ~/.tmux.conf \; display "Config reloaded"

# }}}

# Copy mode, scroll and clipboard {{{
# =============================================================================

## Prefer vi style key table
setw -g mode-keys vi

bind-key y run-shell "tmux save-buffer - | nc -N 127.0.0.1 8377"
yank="nc -N 127.0.0.1 8377"

# Copy selected text
unbind-key -T copy-mode-vi v
bind -T copy-mode-vi 'v' send -X begin-selection                # Begin selection in copy mode.
bind -T copy-mode-vi 'C-v' send -X rectangle-toggle             # Begin selection in copy mode.
bind -T copy-mode-vi 'y' send -X copy-pipe-and-cancel "$yank"   # Yank selection in copy mode.

# bind -T copy-mode-vi Escape send-keys -X cancel

# Copy selection on drag end event, but do not cancel copy mode and do not clear selection
# clear select on subsequence mouse click
# bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe "$yank"
# bind -T copy-mode-vi MouseDown1Pane select-pane; \
#   send -X clear-selection

# }}}

# Appearence and status bar {{{
# =============================================================================

# Icons
# Find Icons: https://www.nerdfonts.com/cheat-sheet

zoom="#{?window_zoomed_flag, ,}"
dl=""
dr=""

c_ia_color="#[fg=colour04]#[bg=colour19]"
c_a_color="#[fg=colour18]#[bg=colour14]"

set -g @cpu_low_fg_color "#[fg=colour07]"
set -g @cpu_medium_fg_color "#[fg=yellow]"
set -g @cpu_high_fg_color "#[fg=red]"

set -g @cpu_medium_thresh "30"
set -g @cpu_high_thresh "80"

set -g @ram_low_fg_color "#[fg=colour07]"
set -g @ram_medium_fg_color "#[fg=yellow]"
set -g @ram_high_fg_color "#[fg=red]"

set -g @ram_medium_thresh "30"
set -g @ram_high_thresh "80"

status_r_off="#([ $(tmux show-option -qv key-table) = 'off' ] && echo '$status_r_is_disabled' || echo '')"
status_os="#([ $(uname 2> /dev/null) = 'Darwin' ] && echo '' || echo ' $HOST') $HOST"
status_r_cpu="#[fg=colour19]#[bg=colour18]$dr#[bg=colour19] #{cpu_fg_color} CPU: #{cpu_icon} #{cpu_percentage} #[fg=colour18]#[bg=colour19]$dr"
status_r_ram="#[fg=colour19]#[bg=colour18]$dr#[bg=colour19] #{ram_fg_color} RAM: #{ram_icon} #{ram_percentage} #[fg=colour18]#[bg=colour19]$dr"
status_r_is_disabled="#[fg=colour01]#[bg=colour18]$dr#[bg=colour01]#[fg=colour07] OFF #[fg=colour18]#[bg=colour01]$dr"
status_r_cal="#[fg=colour19]#[bg=colour18]$dr#[bg=colour19]#[fg=colour07] %d %b  "
status_r_color="#{?client_prefix,#[fg=colour01],#[fg=colour10]}$dr#{?client_prefix,#[bg=colour02],#[bg=colour10]}#[fg=colour0] %H:%M  "

tmux_session=" #{?client_prefix,#[bg=colour01],#[bg=colour10]} #[fg=colour0]$status_os #S #{?client_prefix,#[fg=colour01],#[fg=colour10]} #[bg=colour10]#[bg=colour18]$dl"

# length of tmux status line
set -g status-left-length 30
set -g status-right-length 200

# Make active pane border blue
set -g pane-active-border-style "bg=colour05 fg=colour04"

#Set the left and right status
set -g status-left "$tmux_session"
set -g status-right "$status_r_off$status_r_cal$status_r_color"

# Set the background color
set -g status-bg colour18

set -gw window-status-separator ""

# customize how windows are displayed in the status line
set -gw window-status-format "#[fg=colour18]#[bg=colour19]$dl $c_ia_color #I #[bg=colour19]$c_ia_color$zoom #W #F #[fg=colour19]#[bg=colour18]$dl"
set -gw window-status-current-format "#[fg=colour18]#[bg=colour14]$dl $c_a_color #I #[bg=colour14]$c_a_color$zoom #W #F #[fg=colour14]#[bg=colour18]$dl"

# general status bar settings
set -g status-position top

# }}}

# Nesting local and remote sessions {{{
# =============================================================================

# Session is considered to be remote when we ssh into host
if-shell 'test -n "$SSH_CLIENT"' 'source-file ~/.tmux/tmux.remote.conf'

# Add single prefix for nested tmux sessions
# see: toggle on/off all keybindings · Issue #237 · tmux/tmux - https://github.com/tmux/tmux/issues/237
bind -T root F12 \
    set prefix None \;\
    set key-table off \;\
    if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
    refresh-client -S

bind -T off F12 \
  set -u prefix \;\
  set -u key-table \;\
  refresh-client -S

# }}}

# Plugins {{{
# =============================================================================

# https://github.com/tmux-plugins/tpm
set -g @plugin 'tmux-plugins/tpm'

# https://github.com/tmux-plugins/tmux-sensible
set -g @plugin 'tmux-plugins/tmux-sensible'

# https://github.com/tmux-plugins/tmux-cpu
set -g @plugin 'tmux-plugins/tmux-cpu'

# https://github.com/christoomey/vim-tmux-navigator
set -g @plugin 'christoomey/vim-tmux-navigator'

# https://github.com/mshkrebtan/base16-tmux
set -g @plugin 'mshkrebtan/base16-tmux'

# https://github.com/tmux-plugins/tmux-resurrect
set -g @plugin 'tmux-plugins/tmux-resurrect'

# https://github.com/tmux-plugins/tmux-continuum
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'

# A tmux plugin for opening urls from browser quickly without mouse.
# Doc: https://github.com/wfxr/tmux-fzf-url
set -g @plugin 'wfxr/tmux-fzf-url'

# Plugin properties
set -g @sidebar-tree 't'
set -g @sidebar-tree-focus 'T'
set -g @sidebar-tree-command 'tree -C'

set -g @open-S 'https://www.google.com/search?q='

# Run all plugins' scripts
run -b '~/.tmux/plugins/tpm/tpm'

# }}}
