# Custom Adaptive Tmux Status Bar Configuration
# ==============================================
# 
# Unified status bar that adapts between 1 and 2 lines based on Claude session existence
# Uses Catppuccin Mocha color scheme with custom formatting

# Status bar positioning and basic settings
set -g status-position top
set -g status-interval 5
set -g status-keys vi

# Catppuccin Mocha color definitions - transparent background
set -g status-style "bg=default,fg=#cdd6f4"

# Status left and right configuration
set -g status-left-length 30
set -g status-right-length 80

# Empty status-left to avoid duplication
set -g status-left ""

# System info on right
set -g status-right "#(~/.dotfiles/tmux/scripts/status-line-main.sh)"

# Window status formatting
set -g window-status-separator ""
set -g window-status-format "#[fg=#6c7086] #{window_index}:#{window_name} "
set -g window-status-current-format "#[fg=#89b4fa] #{window_index}:#{window_name}#{?window_zoomed_flag, üîç,} "

# Set initial status conditionally based on Claude sessions
if-shell '[ -n "$($HOME/.dotfiles/tmux/scripts/status-line-claude.sh)" ]' 'set -g status 2' 'set -g status 1'

# Status line 0: Main status bar with host icon, session name and windows
set -g status-format[0] '#[fg=#89b4fa] #(~/.dotfiles/tmux/scripts/host-icon.sh) #S #[fg=#313244] #{W:#{E:window-status-format} ,#{E:window-status-current-format} }#[align=right]#{T;=/#{status-right-length}:status-right}'

# Status line 1: Claude sessions (when available)
set -g status-format[1] '#(~/.dotfiles/tmux/scripts/status-line-claude.sh)'

# Refresh the status bar more frequently to catch Claude session changes
set-hook -g session-created 'refresh-client -S'
set-hook -g session-closed 'run-shell "~/.dotfiles/tmux/scripts/claude-session-cleanup.sh"'
set-hook -g client-session-changed 'refresh-client -S'

# Clean up Claude session tracking when windows/panes are closed
set-hook -g after-kill-pane 'run-shell "~/.dotfiles/tmux/scripts/claude-session-cleanup.sh"'
set-hook -g window-unlinked 'run-shell "~/.dotfiles/tmux/scripts/claude-session-cleanup.sh"'

# Key bindings for status bar control
# Prefix + S: Toggle Claude status line visibility
bind-key S run-shell '
  current_format1="$(tmux show -gv \"status-format[1]\")"
  if [ "$current_format1" != "" ]; then
    tmux set -g status 1
    tmux set -g status-format[1] ""
    tmux refresh-client
    tmux display-message "Sessions status hidden"
  else
    tmux set -g status 2
    tmux set -g status-format[1] "#($HOME/.dotfiles/tmux/scripts/status-line-claude.sh)"
    tmux refresh-client
    tmux display-message "Sessions status shown"
  fi
'

# Prefix + R: Reload status configuration
bind-key R run-shell '
  tmux source-file ~/.dotfiles/tmux/custom-status.conf
  tmux display-message "Status configuration reloaded"
'

# Prefix + I: Show status info (debugging)
bind-key I display-message "Status: #{status} lines, Claude sessions: #($HOME/.dotfiles/tmux/scripts/status-line-claude.sh | wc -c)"

# Enhanced status refresh for better responsiveness
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'

# Activity monitoring (affects status display)
setw -g monitor-activity off
setw -g visual-activity off

# Bell settings (affects status display)
set -g bell-action any
set -g visual-bell off

# Mouse support (doesn't affect status but good for overall experience)
set -g mouse on

# Color definitions for scripts (exported as environment variables)
set-environment -g TMUX_BG "#1e1e2e"
set-environment -g TMUX_TEXT "#cdd6f4"
set-environment -g TMUX_BLUE "#89b4fa"
set-environment -g TMUX_GREEN "#a6e3a1"
set-environment -g TMUX_YELLOW "#f9e2af"
set-environment -g TMUX_RED "#f38ba8"
set-environment -g TMUX_SURFACE "#313244"
set-environment -g TMUX_DIM "#6c7086"