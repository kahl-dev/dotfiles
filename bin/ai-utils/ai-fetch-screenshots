#!/bin/bash
# Fast screenshot retrieval script for AI agents
# Usage: ai-fetch-screenshots [count]
# Returns the most recent N screenshots from ~/tmp/ai/screenshots/

set -euo pipefail

# Function to show help
show_help() {
    cat << EOF
ai-fetch-screenshots - Retrieve recent screenshots for AI agents

USAGE:
    ai-fetch-screenshots [count]
    ai-fetch-screenshots -h|--help

PARAMETERS:
    count       Number of screenshots to retrieve (default: 1)
                Must be a positive integer
    -h, --help  Show this help message

DESCRIPTION:
    Retrieves the most recent screenshots from ~/tmp/ai/screenshots/
    sorted by modification time (newest first). Designed for AI agents
    like Claude, Codex, etc. to quickly access screenshot files.

    Supported image formats: PNG, JPG, JPEG, GIF, WebP

    If the screenshots directory doesn't exist, it will be created
    automatically.

OUTPUT:
    File paths to screenshots, one per line, ordered from newest to oldest.

EXAMPLES:
    # Get the most recent screenshot
    ai-fetch-screenshots

    # Get the 3 most recent screenshots
    ai-fetch-screenshots 3

    # Show help
    ai-fetch-screenshots --help

EXIT CODES:
    0  Success - screenshots found and returned
    1  Error - invalid input or no screenshots found

EOF
    exit 0
}

# Check for help flag
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    show_help
fi

count=${1:-1}
SCREENSHOT_DIR="$HOME/tmp/ai/screenshots"

# Validate count is a positive integer
if ! [[ "$count" =~ ^[1-9][0-9]*$ ]]; then
    echo "Error: count must be a positive integer" >&2
    exit 1
fi

# Create directory if it doesn't exist
if [[ ! -d "$SCREENSHOT_DIR" ]]; then
    mkdir -p "$SCREENSHOT_DIR"
    echo "Info: Created $SCREENSHOT_DIR directory" >&2
fi

# Get the most recent screenshots, sorted by modification time
# Support common image formats
find "$SCREENSHOT_DIR" -maxdepth 1 -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.webp" \) -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -n "$count" | cut -d' ' -f2- || {
    echo "No screenshots found in $SCREENSHOT_DIR/" >&2
    exit 1
}