- defaults:
    link:
      relink: true
      create: true
      force: true
    shell:
      quiet: true
      stdout: true
      stderr: true

- link:
    ~/.config/mise/config.toml: .config/mise/config.toml

- shell:
    - description: "Install mise global tools"
      command: |
        if command -v mise >/dev/null 2>&1; then
          echo "ğŸ” Trusting mise config..."
          mise trust ~/.config/mise/config.toml 2>/dev/null
          mise trust ~/.dotfiles/.config/mise/config.toml 2>/dev/null
          echo "ğŸ“¦ Installing mise global tools..."
          mise install
          echo "âœ“ mise global tools installed"
        else
          echo "âš ï¸  mise not found, skipping global tools install"
        fi

    - description: "Check for duplicate installations"
      command: |
        if ! command -v mise >/dev/null 2>&1; then
          exit 0
        fi

        echo "ğŸ” Checking for duplicate installations..."
        echo ""

        found_duplicates=false

        # â”€â”€ Brew duplicates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if command -v brew >/dev/null 2>&1; then
          brew_mise_overlap="go pnpm python@3.10 python@3.11 pipx shellcheck uv yamllint"
          for pkg in $brew_mise_overlap; do
            if brew list "$pkg" >/dev/null 2>&1; then
              echo "  âš ï¸  brew: $pkg â†’ now managed by mise"
              echo "     Run: brew uninstall $pkg"
              found_duplicates=true
            fi
          done
        fi

        # â”€â”€ fnm global npm packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if command -v fnm >/dev/null 2>&1; then
          mise_npm_tools="yarn pnpm prettier diff-so-fancy serve browser-sync neovim typescript typescript-language-server intelephense pyright @antfu/ni"
          for version in $(fnm list 2>/dev/null | grep -o 'v[0-9]*\.[0-9]*\.[0-9]*'); do
            for pkg in $mise_npm_tools; do
              if fnm exec --using "$version" -- npm ls -g "$pkg" --depth=0 >/dev/null 2>&1; then
                echo "  âš ï¸  fnm ($version): $pkg â†’ now managed by mise"
                echo "     Run: fnm exec --using $version -- npm uninstall -g $pkg"
                found_duplicates=true
              fi
            done
          done
        fi

        # â”€â”€ System/other installations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        mise_binaries="go deno bun shellcheck stylua shfmt yamllint"
        for bin in $mise_binaries; do
          bin_path=$(command -v "$bin" 2>/dev/null) || continue
          case "$bin_path" in
            */mise/shims/*|*/mise/installs/*) continue ;;  # mise-managed, OK
          esac
          echo "  âš ï¸  system: $bin at $bin_path â†’ now managed by mise"
          found_duplicates=true
        done

        echo ""
        if $found_duplicates; then
          echo "ğŸ“‹ Remove the duplicates above so mise is the single source of truth."
          echo "   After removing, run: hash -r  (to refresh shell path cache)"
        else
          echo "âœ“ No duplicates found â€” mise is the single source of truth."
        fi
