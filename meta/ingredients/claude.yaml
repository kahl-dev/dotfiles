- defaults:
    link:
      relink: true
      create: true
      force: true
    shell:
      quiet: false
      stderr: true

- clean: []

- shell:
    - description: "Clone or update Claude private configuration repository"
      command: |
        REPO_DIR="$HOME/repos/claude-config"
        REPO_URL="git@github.com:kahl-dev/claude-config.git"

        if [ ! -d "$REPO_DIR" ]; then
          echo "üì¶ Cloning Claude configuration repository..."
          if ! git clone "$REPO_URL" "$REPO_DIR"; then
            echo "‚ùå ERROR: Failed to clone Claude config repository"
            echo "   Ensure you have access to: $REPO_URL"
            echo "   and your SSH key is configured for GitHub"
            exit 1
          fi
          echo "‚úì Claude configuration cloned successfully"
        else
          echo "üîÑ Updating Claude configuration repository..."
          if ! git -C "$REPO_DIR" pull; then
            echo "‚ö†Ô∏è  Warning: Failed to pull updates, using local version"
          else
            echo "‚úì Claude configuration updated successfully"
          fi
        fi

    - description: "Clean up legacy Claude Code CLI installations (npm/brew)"
      command: |
        FOUND_LEGACY=false

        # üßπ Remove Claude Code from all fnm node versions
        FNM_DIR="$HOME/.local/share/fnm/node-versions"
        if [ -d "$FNM_DIR" ]; then
          setopt NULL_GLOB 2>/dev/null || true
          for node_bin in "$FNM_DIR"/*/installation/bin/claude; do
            [ -e "$node_bin" ] || continue
            if [ -f "$node_bin" ]; then
              NODE_DIR="$(dirname "$node_bin")"
              NPM="$NODE_DIR/npm"
              if [ -x "$NPM" ]; then
                echo "üßπ Removing Claude Code from fnm: $NODE_DIR"
                "$NPM" uninstall -g @anthropic-ai/claude-code 2>/dev/null
                FOUND_LEGACY=true
              fi
            fi
          done
        fi

        # üßπ Remove Claude Code from Homebrew
        if command -v brew >/dev/null 2>&1; then
          if brew list claude-code >/dev/null 2>&1; then
            echo "üßπ Removing Claude Code from Homebrew..."
            brew uninstall claude-code
            FOUND_LEGACY=true
          fi
        fi

        if [ "$FOUND_LEGACY" = true ]; then
          echo "‚úì Legacy Claude Code installations removed"
        else
          echo "‚úì No legacy Claude Code installations found"
        fi

    - description: "Install Claude Code CLI via native installer"
      command: |
        if [ -x "$HOME/.local/bin/claude" ]; then
          echo "‚úì Claude Code CLI already installed at ~/.local/bin/claude"
          "$HOME/.local/bin/claude" --version 2>/dev/null || true
        else
          echo "üì¶ Installing Claude Code CLI..."
          curl -fsSL https://claude.ai/install.sh | bash
          if [ -x "$HOME/.local/bin/claude" ]; then
            echo "‚úì Claude Code CLI installed successfully"
            "$HOME/.local/bin/claude" --version 2>/dev/null || true
          else
            echo "‚ùå ERROR: Claude Code CLI installation failed"
            exit 1
          fi
        fi

    - description: "Clean up legacy RTK installations (brew/sudo/manual)"
      command: |
        CLEANED=false
        if command -v brew >/dev/null 2>&1 && brew list rtk-ai/tap/rtk >/dev/null 2>&1; then
          echo "üßπ Removing RTK from Homebrew..."
          brew uninstall rtk-ai/tap/rtk
          CLEANED=true
        fi
        if [ -f "/usr/local/bin/rtk" ]; then
          echo "üßπ Removing legacy RTK from /usr/local/bin (requires sudo)..."
          sudo rm -f /usr/local/bin/rtk
          CLEANED=true
        fi
        if [ -f "$HOME/.local/bin/rtk" ]; then
          echo "üßπ Removing legacy RTK from ~/.local/bin..."
          rm -f "$HOME/.local/bin/rtk"
          CLEANED=true
        fi
        if [ "$CLEANED" = true ]; then
          echo "‚úì Legacy RTK installations removed"
        else
          echo "‚úì No legacy RTK installations found"
        fi

    - description: "Install or update RTK (Rust Token Killer) via cargo"
      command: |
        eval "$(mise env -s bash rust)" 2>/dev/null

        if ! command -v cargo >/dev/null 2>&1; then
          echo "‚ö†Ô∏è  Rust/cargo not available (add rust to mise config), skipping RTK"
          exit 0
        fi

        LATEST=$(curl -fsSL https://api.github.com/repos/rtk-ai/rtk/releases/latest | grep -o '"tag_name": *"[^"]*"' | head -1 | sed 's/.*"tag_name": *"//;s/"//;s/^v//')
        CURRENT=$(rtk --version 2>/dev/null | grep -o '[0-9]*\.[0-9]*\.[0-9]*' || echo "none")

        if [ "$CURRENT" = "$LATEST" ]; then
          echo "‚úì RTK already up to date ($CURRENT)"
        else
          echo "üì¶ Building RTK $LATEST from source (current: $CURRENT)..."
          cargo install --git https://github.com/rtk-ai/rtk --quiet
          echo "‚úì RTK installed ($(rtk --version 2>/dev/null))"
        fi

    - description: "Create AI workspace directories for Claude"
      command: |
        mkdir -p ~/tmp/ai/screenshots \
                 ~/tmp/ai/jira \
                 ~/tmp/ai/exports \
                 ~/tmp/ai/figma \
                 ~/tmp/ai/downloads \
                 ~/tmp/ai/analysis \
                 ~/tmp/ai/cache

    - description: "Sync claude-config skills as individual symlinks"
      command: |
        SKILLS_SOURCE="$HOME/repos/claude-config/skills"
        SKILLS_TARGET="$HOME/.claude/skills"

        # üîó Remove directory symlink if it exists (migration from old setup)
        if [ -L "$SKILLS_TARGET" ]; then
          echo "üîÑ Migrating skills from directory symlink to individual symlinks..."
          rm "$SKILLS_TARGET"
        fi

        mkdir -p "$SKILLS_TARGET"

        # üîó Link each claude-config skill individually
        linked=0
        for skill in "$SKILLS_SOURCE"/*/; do
          [ -d "$skill" ] || continue
          name=$(basename "${skill%/}")
          # Skip if already correctly linked
          current=$(readlink "$SKILLS_TARGET/$name" 2>/dev/null)
          [ "$current" = "$skill" ] && continue
          # Skip if managed by another source (e.g. skills.sh)
          if [ -L "$SKILLS_TARGET/$name" ] && [ -e "$SKILLS_TARGET/$name" ]; then
            case "$current" in
              *claude-config/skills*) ;; # Ours, safe to overwrite
              *) echo "‚ö†Ô∏è  Skipping $name (managed externally)"; continue ;;
            esac
          fi
          ln -sfn "$skill" "$SKILLS_TARGET/$name"
          linked=$((linked + 1))
        done
        echo "‚úì Linked $linked claude-config skill(s) to ~/.claude/skills/"

- link:
    ~/.claude/agents: ~/repos/claude-config/agents
    ~/.claude/commands: ~/repos/claude-config/commands
    ~/.claude/hooks: ~/repos/claude-config/hooks
    ~/.claude/output-styles: ~/repos/claude-config/output-styles
    ~/.claude/shared: ~/repos/claude-config/shared
    ~/.claude/settings.json: ~/repos/claude-config/settings.json
    ~/.claude/statusline.sh: ~/repos/claude-config/statusline.sh
    ~/.claude/CLAUDE.md: ~/repos/claude-config/GLOBAL.CLAUDE.md

