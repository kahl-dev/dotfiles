- defaults:
    link:
      relink: true
      create: true
      force: true
    shell:
      quiet: false
      stderr: true

- clean: []

- shell:
    - description: "Clone or update Claude private configuration repository"
      command: |
        REPO_DIR="$HOME/repos/claude-config"
        REPO_URL="git@github.com:kahl-dev/claude-config.git"

        if [ ! -d "$REPO_DIR" ]; then
          echo "üì¶ Cloning Claude configuration repository..."
          if ! git clone "$REPO_URL" "$REPO_DIR"; then
            echo "‚ùå ERROR: Failed to clone Claude config repository"
            echo "   Ensure you have access to: $REPO_URL"
            echo "   and your SSH key is configured for GitHub"
            exit 1
          fi
          echo "‚úì Claude configuration cloned successfully"
        else
          echo "üîÑ Updating Claude configuration repository..."
          if ! git -C "$REPO_DIR" pull; then
            echo "‚ö†Ô∏è  Warning: Failed to pull updates, using local version"
          else
            echo "‚úì Claude configuration updated successfully"
          fi
        fi

    - description: "Clean up legacy Claude Code CLI installations (npm/brew)"
      command: |
        FOUND_LEGACY=false

        # üßπ Remove Claude Code from all fnm node versions
        FNM_DIR="$HOME/.local/share/fnm/node-versions"
        if [ -d "$FNM_DIR" ]; then
          for node_bin in "$FNM_DIR"/*/installation/bin/claude; do
            if [ -f "$node_bin" ]; then
              NODE_DIR="$(dirname "$node_bin")"
              NPM="$NODE_DIR/npm"
              if [ -x "$NPM" ]; then
                echo "üßπ Removing Claude Code from fnm: $NODE_DIR"
                "$NPM" uninstall -g @anthropic-ai/claude-code 2>/dev/null
                FOUND_LEGACY=true
              fi
            fi
          done
        fi

        # üßπ Remove Claude Code from Homebrew
        if command -v brew >/dev/null 2>&1; then
          if brew list claude-code >/dev/null 2>&1; then
            echo "üßπ Removing Claude Code from Homebrew..."
            brew uninstall claude-code
            FOUND_LEGACY=true
          fi
        fi

        if [ "$FOUND_LEGACY" = true ]; then
          echo "‚úì Legacy Claude Code installations removed"
        else
          echo "‚úì No legacy Claude Code installations found"
        fi

    - description: "Install Claude Code CLI via native installer"
      command: |
        if [ -x "$HOME/.local/bin/claude" ]; then
          echo "‚úì Claude Code CLI already installed at ~/.local/bin/claude"
          "$HOME/.local/bin/claude" --version 2>/dev/null || true
        else
          echo "üì¶ Installing Claude Code CLI..."
          curl -fsSL https://claude.ai/install.sh | bash
          if [ -x "$HOME/.local/bin/claude" ]; then
            echo "‚úì Claude Code CLI installed successfully"
            "$HOME/.local/bin/claude" --version 2>/dev/null || true
          else
            echo "‚ùå ERROR: Claude Code CLI installation failed"
            exit 1
          fi
        fi

    - description: "Create AI workspace directories for Claude"
      command: |
        mkdir -p ~/tmp/ai/screenshots \
                 ~/tmp/ai/jira \
                 ~/tmp/ai/exports \
                 ~/tmp/ai/figma \
                 ~/tmp/ai/downloads \
                 ~/tmp/ai/analysis \
                 ~/tmp/ai/cache

- link:
    ~/.claude/agents: ~/repos/claude-config/agents
    ~/.claude/commands: ~/repos/claude-config/commands
    ~/.claude/hooks: ~/repos/claude-config/hooks
    ~/.claude/output-styles: ~/repos/claude-config/output-styles
    ~/.claude/shared: ~/repos/claude-config/shared
    ~/.claude/skills: ~/repos/claude-config/skills
    ~/.claude/settings.json: ~/repos/claude-config/settings.json
    ~/.claude/statusline.sh: ~/repos/claude-config/statusline.sh
    ~/.claude/CLAUDE.md: ~/repos/claude-config/GLOBAL.CLAUDE.md

